(function(){"use strict";var t={1121:function(t,e,s){var n=s(5130),a=s(6768);function i(t,e,s,n,i,r){const d=(0,a.g2)("ClassroomManager");return(0,a.uX)(),(0,a.Wv)(d)}var r=s(4232);const d={class:"classroom-manager"},o={class:"tabs-container"},u=["onClick","title"],l=["disabled"],c={key:1,class:"loading-message"};function h(t,e,s,n,i,h){const m=(0,a.g2)("MyClassroom");return(0,a.uX)(),(0,a.CE)("div",d,[e[2]||(e[2]=(0,a.Lk)("h1",null,"教室の管理",-1)),(0,a.Lk)("div",o,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.tabs,t=>((0,a.uX)(),(0,a.CE)("button",{key:t.id,onClick:e=>h.selectTab(t.id),class:(0,r.C4)({"active-tab":t.id===i.activeTabId}),title:t.title+" (Created: "+t.creationDate+")"},(0,r.v_)(t.title),11,u))),128)),(0,a.Lk)("button",{onClick:e[0]||(e[0]=(...t)=>h.randomizeCurrentList&&h.randomizeCurrentList(...t))},"再編成する"),(0,a.Lk)("button",{onClick:e[1]||(e[1]=(...t)=>h.saveAsNewTab&&h.saveAsNewTab(...t)),disabled:!h.currentTab},"新しい組織を決定する",8,l)]),h.currentDeskLayout.length>0&&i.initialLoadComplete?((0,a.uX)(),(0,a.Wv)(m,{key:0,desks:h.currentDeskLayout,classroomTitle:h.currentTab?h.currentTab.title:"教室のレイアウト"},null,8,["desks","classroomTitle"])):((0,a.uX)(),(0,a.CE)("div",c," 教室のレイアウトを読み込み中．．． "))])}s(4114),s(8111),s(2489),s(116),s(531),s(7588),s(1701),s(3579),s(7642),s(8004),s(3853),s(5876),s(2475),s(5024),s(1698);const m={class:"my-classroom"},f={class:"desks-container"};function g(t,e,s,n,i,d){const o=(0,a.g2)("StudentDesk");return(0,a.uX)(),(0,a.CE)("div",m,[(0,a.Lk)("h2",null,(0,r.v_)(s.classroomTitle),1),e[0]||(e[0]=(0,a.Lk)("div",{class:"whiteboard"},null,-1)),(0,a.Lk)("div",f,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(d.deskRows,(t,e)=>((0,a.uX)(),(0,a.CE)("div",{class:"desk-row",key:e},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(t,(t,e)=>((0,a.uX)(),(0,a.Wv)(o,{key:t.id||e,deskName:t.name,students:t.students},null,8,["deskName","students"]))),128))]))),128))])])}const p=["onClick"],b={key:0,class:"empty-chair-placeholder"},y={key:1,class:"student-info-details"},k={class:"desk-name"};function v(t,e,s,n,i,d){return(0,a.uX)(),(0,a.CE)("div",{class:(0,r.C4)(["desk",{"single-student-desk":1===s.students.length&&!1===s.students[0].isEmpty}])},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.students,t=>((0,a.uX)(),(0,a.CE)("div",{class:(0,r.C4)(["student",["gender-"+t.gender_id,{"is-empty":t.isEmpty}]]),key:t.id,onClick:e=>t.isEmpty?null:d.toggleStudentInfo(t.id)},[t.isEmpty?((0,a.uX)(),(0,a.CE)("div",b)):i.selectedStudentId===t.id?((0,a.uX)(),(0,a.CE)("div",y,[(0,a.Lk)("p",null,[(0,a.Lk)("strong",null,(0,r.v_)(t.name),1)]),(0,a.Lk)("p",null,(0,r.v_)(t.hiragana),1)])):((0,a.uX)(),(0,a.CE)("div",{key:2,class:(0,r.C4)(["student-initial",{"font-small":t.name.length>3}])},(0,r.v_)(t.name),3))],10,p))),128)),(0,a.Lk)("div",k,(0,r.v_)(s.deskName),1)],2)}var S={name:"StudentDesk",props:{deskName:{type:String,required:!0},students:{type:Array,default:()=>[]}},data(){return{selectedStudentId:null}},methods:{toggleStudentInfo(t){this.selectedStudentId=this.selectedStudentId===t?null:t}}},L=s(1241);const _=(0,L.A)(S,[["render",v],["__scopeId","data-v-139845cd"]]);var w=_,T={name:"MyClassroom",components:{StudentDesk:w},props:{desks:{type:Array,default:()=>[]},classroomTitle:{type:String,default:"教室のレイアウト"}},computed:{deskRows(){const t=[],e=this.desks;for(let s=0;s<e.length;s+=2)t.push(e.slice(s,s+2));return t}}};const I=(0,L.A)(T,[["render",g],["__scopeId","data-v-ba4df9a4"]]);var E=I,C=s(6400),D=s(4388),M=s(2832);const N="undefined"!==typeof __firebase_config?JSON.parse(__firebase_config):{apiKey:"AIzaSyAcjyDX_tAYYxWxP8Y1N1CBh_XwVf4XtgM",authDomain:"classroom-b81c6.firebaseapp.com",projectId:"classroom-b81c6",storageBucket:"classroom-b81c6.firebasestorage.app",messagingSenderId:"903823177785",appId:"1:903823177785:web:68340bb3d3a6f6eb6775e8"},F="undefined"!==typeof __initial_auth_token?__initial_auth_token:null,A="undefined"!==typeof __app_id?__app_id:"classroom-b81c6",X=(0,C.Wp)(N),x=(0,D.xI)(X),O=(0,M.aU)(X);let j=new Promise(t=>{(0,D.hg)(x,async e=>{if(e)console.log("Firebase authenticated. User ID:",e.uid),t(e.uid);else try{F?await(0,D.p)(x,F):await(0,D.zK)(x),console.log("Firebase auth attempt complete."),t(x.currentUser?x.currentUser.uid:null)}catch(s){console.error("Firebase authentication failed:",s),t(null)}})});var $={name:"ClassroomManager",components:{MyClassroom:E},data(){return{masterStudentList:[],allStudentsMap:new Map,tabs:[],activeTabId:null,emptyStudentPlaceholder:{id:"empty-slot",name:"",hiragana:"",gender_id:0,isEmpty:!0},isFirestoreReady:!1,initialLoadComplete:!1,masterListSaved:!1,c1List:[],c2List:[],c3List:[]}},async created(){await j,this.isFirestoreReady=!0,await this.loadMasterStudentList(),0===this.masterStudentList.length?(console.log("No master student list found, initializing defaults."),this.initializeDefaultMasterStudentList()):(this.masterStudentList.forEach(t=>{this.allStudentsMap.set(t.id,t)}),this.masterListSaved=!0),await this.loadTabsFromFirestore(),this.initialLoadComplete=!0,this.tabs.length>0&&!this.activeTabId&&(this.activeTabId=this.tabs[0].id)},computed:{currentTab(){return this.tabs.find(t=>t.id===this.activeTabId)||null},currentDeskLayout(){return this.currentTab?this.currentTab.deskLayout:[]}},methods:{initializeDefaultMasterStudentList(){this.masterStudentList=[{id:2,name:"熱田",hiragana:"あつた",gender_id:2},{id:3,name:"大塚",hiragana:"おおつか",gender_id:1},{id:4,name:"岡田",hiragana:"おかだ",gender_id:2},{id:5,name:"河井",hiragana:"かわい",gender_id:1},{id:6,name:"川口",hiragana:"かわぐち",gender_id:2},{id:7,name:"川田",hiragana:"かわた",gender_id:2},{id:8,name:"MOTTA",hiragana:"もった",gender_id:1},{id:9,name:"里舘",hiragana:"さとだて",gender_id:1},{id:10,name:"塩田",hiragana:"しおた",gender_id:1},{id:11,name:"新岡",hiragana:"にいおか",gender_id:1},{id:12,name:"樋口",hiragana:"ひぐち",gender_id:2},{id:13,name:"堀口",hiragana:"ほりぐち",gender_id:2},{id:14,name:"松井",hiragana:"まつい",gender_id:1},{id:15,name:"松川",hiragana:"まつかわ",gender_id:1},{id:16,name:"水上",hiragana:"みずかみ",gender_id:2},{id:17,name:"宮澤",hiragana:"みやざわ",gender_id:1},{id:18,name:"山角",hiragana:"やまかど",gender_id:1},{id:19,name:"山田",hiragana:"やまだ",gender_id:1}],this.c1List=[],this.c2List=[],this.c3List=[],this.masterStudentList.forEach(t=>{this.allStudentsMap.set(t.id,t)})},async saveMasterStudentListInit(){if(!x.currentUser||!this.isFirestoreReady)return void console.warn("Firestore not ready or user not authenticated, cannot save.");if(this.masterListSaved)return void alert("マスター学生リストはすでに保存されています。");const t=(0,M.rJ)(O,`artifacts/${A}/students`);try{for(const e of this.masterStudentList)await(0,M.BN)((0,M.H9)(t,String(e.id)),{name:e.name,hiragana:e.hiragana,gender_id:e.gender_id});console.log("Master student list successfully saved to /students collection."),alert("マスター学生リストがFirestoreに保存されました。"),this.masterListSaved=!0}catch(e){console.error("Error saving master student list:",e),alert("マスター学生リストの保存中にエラーが発生しました。")}},async loadMasterStudentList(){if(!x.currentUser||!this.isFirestoreReady)return void console.warn("Firestore not ready or user not authenticated, cannot load master list.");const t=(0,M.rJ)(O,`artifacts/${A}/students`);try{(0,M.aQ)(t,t=>{const e=[],s=new Map;t.forEach(t=>{const n={id:parseInt(t.id),...t.data()};e.push(n),s.set(n.id,n)}),this.masterStudentList=e,this.allStudentsMap=s,console.log("Master student list loaded from Firestore."),e.length>0&&(this.masterListSaved=!0)},t=>{console.error("Error listening to master student list from Firestore:",t)})}catch(e){console.error("Error setting up master student list listener:",e)}},shuffleArray(t){for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t},assignStudentsToDesks(t){const e=9,s=Array.from({length:e},(t,e)=>({id:`desk-${e+1}`,name:`${e+1}`,students:[]})),n=t.map(t=>({...t})),a=new Map;n.forEach(t=>{t.deskNumber&&!t.isEmpty&&(a.has(t.deskNumber)||a.set(t.deskNumber,[]),a.get(t.deskNumber).push(t))});const i=new Set;a.forEach((t,e)=>{const n=e-1;if(s[n])for(let a=0;a<Math.min(t.length,2);a++)s[n].students.push(t[a]),i.add(t[a].id)});const r=n.filter(t=>!i.has(t.id));let d=0;s.forEach(t=>{while(t.students.length<2)if(d<r.length){const e=r[d++];e.deskNumber=parseInt(t.name),t.students.push(e),i.add(e.id)}else t.students.push({...this.emptyStudentPlaceholder,id:`empty-${t.name}-${t.students.length+1}`})});const o=s.flatMap(t=>t.students.filter(t=>!t.isEmpty));return{deskLayout:s,studentsWithDeskNumbers:o}},async addTab(t,e,s=!1){const n=this.tabs.length>0?Math.max(...this.tabs.map(t=>t.id))+1:1,a=(new Date).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"}),{deskLayout:i,studentsWithDeskNumbers:r}=this.assignStudentsToDesks(e),d=r.map(t=>({studentId:t.id,deskNumber:t.deskNumber})),o={id:n,title:t,creationDate:a,studentAssignments:d,deskLayout:i,firestoreDocId:null};if(this.tabs.push(o),this.tabs.sort((t,e)=>t.id-e.id),s&&this.isFirestoreReady){const t=await this.saveTabToFirestore(o);o.firestoreDocId=t}},async randomizeCurrentList(){if(!this.currentTab)return void console.warn("No active tab selected. Cannot randomize.");const t=this.currentTab.deskLayout.flatMap(t=>t.students.filter(t=>!t.isEmpty)),e=this.tabs.filter(t=>t.id!==this.currentTab.id),{studentsByDesk:s,deskmates:n}=this.getHistoricalData(e),a=Array.from({length:9},(t,e)=>e+1),i=[],r=new Set;this.shuffleArray(t);for(const g of a){const e=[];while(e.length<2&&t.length>0){const a=this.findValidStudent(t,g,e,s,n,r);if(!a)break;e.push(a),r.add(a.id),t.splice(t.findIndex(t=>t.id===a.id),1)}e.forEach(t=>{t.isEmpty||i.push({studentId:t.id,deskNumber:g})})}const d="temp-randomized",o=(new Date).toLocaleDateString("ja-JP",{year:"numeric",month:"long",day:"numeric"}),u=`再編成 ${o}`,l=i.map(t=>({id:t.studentId,deskNumber:t.deskNumber,...this.allStudentsMap.get(t.studentId)})),{deskLayout:c,studentsWithDeskNumbers:h}=this.assignStudentsToDesks(l),m={id:d,title:u,creationDate:o,studentAssignments:h.map(t=>({studentId:t.id,deskNumber:t.deskNumber})),deskLayout:c,firestoreDocId:null},f=this.tabs.findIndex(t=>t.id===d);-1!==f&&this.tabs.splice(f,1),this.tabs.push(m),this.tabs.sort((t,e)=>t.id===d?1:e.id===d?-1:t.id-e.id),this.activeTabId=d},findValidStudent(t,e,s,n,a,i){const r=this.shuffleArray([...t]);for(const d of r){const t=d.id;if(i.has(t))continue;const r=n.get(t)||new Set;if(r.has(String(e)))continue;let o=!0;const u=a.get(t)||new Set;for(const e of s)if(u.has(e.id)){o=!1;break}if(o)return d}return null},async saveAsNewTab(){if(!this.masterStudentList.length>0)return void alert("まず、マスター学生リストを保存してください。");const t=this.currentTab?this.currentTab.deskLayout.flatMap(t=>t.students.filter(t=>!t.isEmpty)):[...this.masterStudentList],e=`${this.convertToKanji(this.tabs.length)} 第`;await this.addTab(e,t,!0),this.selectTab(this.tabs[this.tabs.length-1].id)},selectTab(t){this.activeTabId=t},async saveTabToFirestore(t,e=null){if(!x.currentUser||!this.isFirestoreReady)return console.warn("Firestore not ready or user not authenticated, cannot save."),null;const s=(0,M.rJ)(O,`artifacts/${A}/classrooms`);try{let n;return e?n=(0,M.H9)(s,e):(n=(0,M.H9)(s),t.id=n.id),await(0,M.BN)(n,{title:t.title,creationDate:t.creationDate,studentAssignments:t.studentAssignments}),console.log("Classroom layout document successfully written with ID: ",n.id),n.id}catch(n){return console.error("Error writing document to Firestore: ",n),null}},async loadTabsFromFirestore(){if(!x.currentUser||!this.isFirestoreReady)return void console.warn("Firestore not ready or user not authenticated, cannot load tabs.");const t=(0,M.rJ)(O,`artifacts/${A}/classrooms`);try{(0,M.aQ)(t,async t=>{const e=[],s=new Set;t.forEach(t=>{const n=t.data(),a=Array.isArray(n.studentAssignments)?n.studentAssignments:[];a.forEach(t=>{t.studentId&&s.add(t.studentId)}),e.push({id:t.id,title:n.title,creationDate:n.creationDate,studentAssignments:a,deskLayout:[],firestoreDocId:t.id})});const n=new Map;if(s.size>0){const t=Array.from(s).map(t=>(0,M.x7)((0,M.H9)(O,`artifacts/${A}/students`,String(t)))),e=await Promise.all(t);e.forEach(t=>{if(t.exists()){const e={id:parseInt(t.id),...t.data()};n.set(e.id,e)}})}this.tabs=e.map(t=>{const e=t.studentAssignments.map(t=>{const e=n.get(t.studentId);return e?{...e,deskNumber:t.deskNumber}:{...this.emptyStudentPlaceholder,id:`missing-student-${t.studentId}`}}).filter(t=>!t.isEmpty),{deskLayout:s,studentsWithDeskNumbers:a}=this.assignStudentsToDesks(e);return{...t,studentAssignments:a.map(t=>({studentId:t.id,deskNumber:t.deskNumber})),deskLayout:s}}),this.tabs.sort((t,e)=>t.id-e.id),this.initialLoadComplete&&this.tabs.length>0&&!this.tabs.some(t=>t.id===this.activeTabId)||this.tabs.length>0&&!this.activeTabId?this.activeTabId=this.tabs[0].id:0===this.tabs.length&&(this.activeTabId=null),console.log("Tabs loaded/updated from Firestore.")},t=>{console.error("Error listening to tabs from Firestore:",t)})}catch(e){console.error("Error setting up Firestore listener:",e)}},addInitialTabs(){0===this.tabs.length&&this.masterStudentList.length>0&&(console.log("No classroom tabs found. Creating initial layouts."),this.addTab("基本順序",[...this.masterStudentList],!0))},getHistoricalData(t=this.tabs){const e=new Map,s=new Map;return t.forEach(t=>{t.deskLayout.forEach(t=>{const n=t.students.map(t=>t.id).filter(t=>"empty-slot"!==t);if(n.forEach(s=>{e.has(s)||e.set(s,new Set),e.get(s).add(t.name)}),2===n.length){const[t,e]=n;s.has(t)||s.set(t,new Set),s.has(e)||s.set(e,new Set),s.get(t).add(e),s.get(e).add(t)}})}),{studentsByDesk:e,deskmates:s}},convertToKanji(t){const e=["零","一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九"];return t>=0&&t<e.length?e[t]:t.toString()}}};const z=(0,L.A)($,[["render",h],["__scopeId","data-v-853b35cc"]]);var P=z,R={name:"App",components:{ClassroomManager:P}};const W=(0,L.A)(R,[["render",i]]);var K=W;(0,n.Ef)(K).mount("#app")}},e={};function s(n){var a=e[n];if(void 0!==a)return a.exports;var i=e[n]={exports:{}};return t[n].call(i.exports,i,i.exports,s),i.exports}s.m=t,function(){var t=[];s.O=function(e,n,a,i){if(!n){var r=1/0;for(l=0;l<t.length;l++){n=t[l][0],a=t[l][1],i=t[l][2];for(var d=!0,o=0;o<n.length;o++)(!1&i||r>=i)&&Object.keys(s.O).every(function(t){return s.O[t](n[o])})?n.splice(o--,1):(d=!1,i<r&&(r=i));if(d){t.splice(l--,1);var u=a();void 0!==u&&(e=u)}}return e}i=i||0;for(var l=t.length;l>0&&t[l-1][2]>i;l--)t[l]=t[l-1];t[l]=[n,a,i]}}(),function(){s.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return s.d(e,{a:e}),e}}(),function(){s.d=function(t,e){for(var n in e)s.o(e,n)&&!s.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"===typeof window)return window}}()}(),function(){s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}}(),function(){var t={524:0};s.O.j=function(e){return 0===t[e]};var e=function(e,n){var a,i,r=n[0],d=n[1],o=n[2],u=0;if(r.some(function(e){return 0!==t[e]})){for(a in d)s.o(d,a)&&(s.m[a]=d[a]);if(o)var l=o(s)}for(e&&e(n);u<r.length;u++)i=r[u],s.o(t,i)&&t[i]&&t[i][0](),t[i]=0;return s.O(l)},n=self["webpackChunkclass_room"]=self["webpackChunkclass_room"]||[];n.forEach(e.bind(null,0)),n.push=e.bind(null,n.push.bind(n))}();var n=s.O(void 0,[504],function(){return s(1121)});n=s.O(n)})();
//# sourceMappingURL=app.a71de8f1.js.map